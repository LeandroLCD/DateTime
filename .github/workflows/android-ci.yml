name: Android CI # Nombre de tu workflow, visible en la pestaña Actions de GitHub

on:
  push:
    branches: [ "main", "develop" ] # Se ejecuta cuando se hace push a estas ramas

  pull_request:
    branches: [ "main", "develop" ] # Se ejecuta cuando se abre un Pull Request a estas ramas

jobs: # Define uno o más "jobs" (trabajos) que se ejecutarán
  build: # Este es el nombre de tu primer job. Puedes ponerle 'android_build' o lo que quieras.
    runs-on: ubuntu-latest # Especifica en qué tipo de máquina virtual se ejecutará este job (Linux en este caso)

    steps: # Los pasos que este job va a ejecutar
    - name: Checkout Code # Descarga tu código del repositorio
      uses: actions/checkout@v4

    - name: Set up JDK 17 # Configura Java Development Kit (JDK) 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin' # Distribución de JDK recomendada
        java-version: '17' # Versión de Java, coincide con tu jvmTarget
        cache: 'gradle' # Cachea dependencias de Gradle para compilaciones más rápidas

    - name: Grant execute permission for gradlew # Da permisos de ejecución al wrapper de Gradle
      run: chmod +x gradlew

    - name: Run Instrumented Tests with GMD
      run: ./gradlew managedDevice<pixel2>Test --stacktrace -Pandroid.testoptions.manageddevices.emulator.gpu=swiftshader_indirect
        # Reemplaza <DeviceName> con el nombre del dispositivo que definas en tu archivo build.gradle
        # Por ejemplo, si lo llamas 'pixel3a', el comando será './gradlew managedDevicePixel3aTest'
        # La propiedad para la GPU es necesaria en entornos de CI sin aceleración gráfica


    - name: Generate Coverage Report and Upload to Coveralls
      env:
        COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
      run: ./gradlew :Library:jacocoAndroidTestReport :Library:coverallsJacoco
